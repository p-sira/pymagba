# PyMagba is licensed under The 3-Clause BSD, see LICENSE.
# Copyright 2025 Sira Pornsiriprasert <code@psira.me>


from numpy.testing import assert_allclose
from scipy.spatial.transform import Rotation
from pymagba.sources import CylinderMagnet, SourceCollection
import numpy as np


def test_cylinder_collection() -> None:
    magnet_positions = np.array(
        [
            [0.009389999999999999, 0.0, -0.006],
            [0.0029016695771807563, 0.008930420688011491, -0.006],
            [-0.007596669577180755, 0.005519303519026323, -0.006],
            [-0.007596669577180757, -0.005519303519026321, -0.006],
            [0.002901669577180754, -0.008930420688011491, -0.006],
        ]
    )
    magnet_orientations = np.array(
        [
            [
                0.5,
                0.4999999999999999,
                0.5,
                0.5000000000000001,
            ],
            [
                -0.6984011233337103,
                0.11061587104123723,
                0.11061587104123725,
                -0.6984011233337104,
            ],
            [
                -0.32101976096010304,
                0.6300367553350505,
                0.6300367553350507,
                -0.3210197609601031,
            ],
            [
                -0.32101976096010315,
                -0.6300367553350504,
                -0.6300367553350504,
                -0.3210197609601032,
            ],
            [
                -0.6984011233337103,
                -0.11061587104123705,
                -0.11061587104123706,
                -0.6984011233337104,
            ],
        ]
    )
    magnet_radius = 1.5e-3
    magnet_height = 4e-3
    magnet_polarization = np.array((0, 0, 925e-3))
    points = np.array(
        [
            [0.016269076615571976, 9.293209257688062e-11, -0.004999999888241291],
            [0.017554890364408493, 0.011071303859353065, -0.004999999888241291],
            [0.007652164436876774, 0.018202807754278183, -0.004999999888241291],
            [-0.0017086314037442207, 0.0185789056122303, -0.004999999888241291],
            [-0.008750000037252903, 0.017320508137345314, -0.004999999888241291],
            [-0.014261103235185146, 0.011841483414173126, -0.004999999888241291],
            [-0.017117582261562347, 0.004158233758062124, -0.004999999888241291],
            [-0.01804199069738388, -0.0043827928602695465, -0.004999999888241291],
            [-0.015939079225063324, -0.013234764337539673, -0.004999999888241291],
            [-0.009492765180766582, -0.018790801987051964, -0.004999999888241291],
            [-0.001798264100216329, -0.01955353282392025, -0.004999999888241291],
            [0.004657331854104996, -0.016381479799747467, -0.004999999422580004],
            [0.010942613705992699, -0.013889148831367493, -0.004999999422580004],
            [0.015057665295898914, -0.007661832962185144, -0.004999999888241291],
            [0.019083134829998016, 0.003925683442503214, -0.010999999940395355],
            [0.012041906826198101, 0.014548053964972496, -0.010999999940395355],
            [0.0020485075656324625, 0.017005201429128647, -0.010999999940395355],
            [-0.006851730868220329, 0.015033936128020287, -0.010999999940395355],
            [-0.0135755380615592, 0.007724771276116371, -0.010999999940395355],
            [-0.014484383165836334, -0.00018855510279536247, -0.010999999940395355],
            [-0.012000384740531445, -0.014497889205813408, -0.010999999940395355],
            [-0.002083655446767807, -0.01729697361588478, -0.010999999940395355],
            [0.006133161950856447, -0.013457266613841057, -0.010999999940395355],
            [0.012905428186058998, -0.007343464531004429, -0.010999999940395355],
            [0.017608724534511566, 0.0, -0.017000000923871994],
            [0.015017593279480934, 0.009899495169520378, -0.017000000923871994],
            [7.654042311669416e-19, 0.013349059969186783, -0.017000000923871994],
            [-0.006743650883436203, 0.009899495169520378, -0.017000000923871994],
            [-0.008636685088276863, 1.714505527444786e-18, -0.017000000923871994],
            [-0.008368524722754955, -0.009899495169520378, -0.017000000923871994],
            [-2.2962128485971897e-18, -0.014775779098272324, -0.017000000923871994],
            [0.008838835172355175, -0.010148122906684875, -0.017000000923871994],
            [0.008816778659820557, 0.018806597217917442, 0.0010000000474974513],
            [0.006101049482822418, -0.018369855359196663, 0.0010000000474974513],
            [0.01753106340765953, -0.005407797172665596, 0.0010000000474974513],
            [0.01917305961251259, 0.0018292481545358896, 0.0010000000474974513],
            [0.01686449535191059, 0.012068596668541431, 0.0010000000474974513],
            [-0.010207989253103733, 0.015506377443671227, 0.0010000000474974513],
            [-0.008501795120537281, -0.020429426804184914, 0.0010000000474974513],
            [-0.014484383165836334, -0.00823979638516903, -0.010999999940395355],
        ]
    )
    magpy_b = np.array(
        [
            [0.013018239702599438, 0.0005069273213531204, 0.0030187431145745217],
            [-0.0007908607194865435, 0.001504740238917399, 3.4124357944015344e-05],
            [-0.0022321253277515912, -0.0034921149127960494, -0.0005595089384017167],
            [0.0027904171090079592, -0.0018937251244135053, -0.00032561540565438076],
            [0.0015072942650384692, 0.0018069828459072127, 0.00015467773111253833],
            [-0.0037158553373808235, 0.004170832848168313, 0.0009139669116307343],
            [-0.0031783252009801284, -0.002820498243553457, 0.0004810984766645139],
            [0.0029148761815332397, -0.002038116132542915, -0.0003632237588728328],
            [0.00219690814792707, 0.0023581569916523186, -0.00039637576720836284],
            [-0.0009180491488466388, 0.0015819896059938792, -0.00011003906201090991],
            [-0.0022697614810904773, -0.00110193920252091, 0.00021344443345768698],
            [0.0012369690396184293, -0.009388267227816148, 0.0019364846367002889],
            [0.0034172087963762043, -0.001029279602135164, 0.0006319793291303479],
            [0.0007166881070010896, -0.002338005240930703, 0.0005128822187796101],
            [0.0013174721405169326, 0.001582311385876527, -0.0014255093943416472],
            [-0.0022249948479398274, 2.0688087859448655e-05, 0.0010849845129484025],
            [0.0015013165772913477, -0.003067741833790076, 0.003127680379423371],
            [0.002373643434882282, 0.0014667087640668965, -0.0007194993515875737],
            [-0.003712218190595134, 1.195489716964969e-05, -0.005729842877360716],
            [0.0003516426864693879, -0.0036770267126931557, 0.00021525075782227073],
            [0.00019182795697916994, 0.0025086088085336236, 0.001663552980506693],
            [-0.0025370552375435238, -0.00036717068131802505, -0.001025307180240398],
            [0.002485526841868072, -0.0014919507307270578, -0.007234831383892417],
            [-0.0009481425519979158, -0.0007162917692444437, -0.0017346804172720185],
            [4.395753318942833e-05, 0.00032143069069636484, -0.0011506702325350501],
            [-0.0006217111232839334, 0.0006792344899499838, -9.637241422702335e-07],
            [0.0008265480779178927, 9.730696004113437e-05, 0.0011204940560142187],
            [0.0010613107144053983, -3.9348420451788054e-05, -0.0005939989117128251],
            [0.00026195454304601967, -0.0007219816020297379, 0.00029746214772797907],
            [-0.0006437444696350726, 0.0003197790636926979, 0.001332209517730673],
            [-0.0009756114803343964, 0.0003835081462766128, -0.0007669452116776146],
            [-0.000440850881400434, 0.0007163849434861868, -0.0008262677234463359],
            [-0.0008977137963780021, -0.0009522170177980092, -0.0011795018725367552],
            [4.1995684432490955e-05, -0.0011991073081845784, 0.0016631263946701588],
            [0.0006108474375200214, -0.0006475531247678297, 0.0015533503391909646],
            [0.0010176524016519651, 0.0007956646090499336, 0.001603292180332558],
            [-0.0007741830246314587, 0.0008128430734230785, -4.641045345929847e-05],
            [0.0007537231143906614, 0.0012154958853506698, 0.0010158746107070606],
            [-0.0006889658890387588, 0.0006264651580951153, -0.00020117451394079547],
            [0.0037293659102091647, 0.0005583449015105614, 0.004236056420621902],
        ]
    )

    magnets = []
    for position, orientation in zip(magnet_positions, magnet_orientations):
        magnets.append(
            CylinderMagnet(
                position,
                Rotation.from_quat(orientation),
                magnet_radius,
                magnet_height,
                magnet_polarization,
            )
        )

    collection = SourceCollection(magnets)
    magba_b = collection.get_B(points)

    assert_allclose(magba_b, magpy_b)

    # Set new magnet position
    magpy_b = np.array(
        [
            [-4.7956451164138664e-08, 2.1176406808209044e-08, -1.0111478788178746e-08],
            [-4.98388447426471e-08, 2.3526053265867696e-08, -9.187545592106503e-09],
            [-4.8856163937102e-08, 2.6549389363358076e-08, -4.546862012064413e-09],
            [-4.678863659637099e-08, 2.7727817450920084e-08, -1.3039364669707882e-09],
            [-4.497430329515295e-08, 2.816752395839289e-08, 6.854685263999735e-10],
            [-4.31259848726327e-08, 2.750772055913691e-08, 1.2854988907622816e-09],
            [-4.174884681919649e-08, 2.616432453427188e-08, 7.188433101615029e-10],
            [-4.073467763087785e-08, 2.4506901640845084e-08, -4.142114955158928e-10],
            [-4.0276939648504784e-08, 2.2521794071820653e-08, -2.2165660751966336e-09],
            [-4.088893245000982e-08, 2.0699479512382614e-08, -4.55873533582431e-09],
            [-4.215266269119843e-08, 1.9588275295215084e-08, -6.692488375813664e-09],
            [-4.365892111400326e-08, 1.9356062103223337e-08, -8.190350432289235e-09],
            [-4.501928344197193e-08, 1.8965932340091855e-08, -9.821964943073601e-09],
            [-4.659582100970925e-08, 1.9671036211488728e-08, -1.0518816679062996e-08],
            [-4.69537681856554e-08, 2.0950284971006215e-08, -1.0250041343992758e-08],
            [-4.72019745841764e-08, 2.421785300001437e-08, -6.491745387809718e-09],
            [-4.5515569730100546e-08, 2.5921418934573635e-08, -2.8151041365722e-09],
            [-4.3398745409006626e-08, 2.641177034291948e-08, -4.251112695972111e-10],
            [-4.1251005414332315e-08, 2.5558288267883913e-08, 2.2868393500775103e-10],
            [-4.03344472914205e-08, 2.408949648844976e-08, -7.803474371745151e-10],
            [-3.93870843141109e-08, 2.110055555901412e-08, -3.3508592640670404e-09],
            [-4.0777277559691334e-08, 1.944509727496524e-08, -6.211823570330851e-09],
            [-4.2567584973082316e-08, 1.914895036143468e-08, -8.075255495883273e-09],
            [-4.442627275046315e-08, 1.9456380317374068e-08, -9.464099800724723e-09],
            [-4.425962876577402e-08, 1.9692481685322426e-08, -9.824722025580892e-09],
            [-4.5149598319003694e-08, 2.2035164129193354e-08, -7.869472474124443e-09],
            [-4.288504479294243e-08, 2.442009607493705e-08, -2.753152634725476e-09],
            [-4.123372137081551e-08, 2.4398857955479505e-08, -1.3661449120053705e-09],
            [-3.99373560067792e-08, 2.270547312497271e-08, -2.3085184381107417e-09],
            [-3.9005314098367007e-08, 2.085315990057886e-08, -3.6524454916134142e-09],
            [-3.983336741383341e-08, 1.905452805198621e-08, -6.3269478405868154e-09],
            [-4.170247265714816e-08, 1.8851094008237165e-08, -8.252228275397457e-09],
            [-5.137191189364651e-08, 2.7589595130686097e-08, -4.967502539301585e-09],
            [-4.538689340618054e-08, 1.9313848577346526e-08, -9.073194817313149e-09],
            [-4.9370531687526286e-08, 2.038339376770068e-08, -1.1513007740008036e-08],
            [-5.0859578563396624e-08, 2.182425442988559e-08, -1.1315489946721598e-08],
            [-5.21002556530911e-08, 2.471874215159397e-08, -9.112853814204425e-09],
            [-4.6284557332155435e-08, 2.9069198164374132e-08, 9.528570908692837e-10],
            [-4.246172537792604e-08, 2.093421674674763e-08, -5.102659899762737e-09],
            [-3.9560707417343174e-08, 2.2539623319588308e-08, -1.9291314492215833e-09],
        ]
    )
    collection.position = np.array((0.1, 0.2, 0.3))
    magba_b = collection.get_B(points)
    assert_allclose(magba_b, magpy_b)

    # Set new magnet orientation
    magpy_b = np.array(
        [
            [-4.1387067333332674e-08, 1.9318003201006036e-08, 2.7320056754571453e-08],
            [-4.340797889127702e-08, 1.9674430805670637e-08, 2.9275765861751446e-08],
            [-4.1325100721850305e-08, 2.137479180686719e-08, 3.314814327047096e-08],
            [-3.830058511105505e-08, 2.251631998156462e-08, 3.515694609792492e-08],
            [-3.583679073964543e-08, 2.3198614197633556e-08, 3.610070727700683e-08],
            [-3.353555388965624e-08, 2.348561812886264e-08, 3.5634898507782026e-08],
            [-3.1984066188732094e-08, 2.3384684407004776e-08, 3.42161000684199e-08],
            [-3.0996377186002095e-08, 2.302834194520163e-08, 3.238162354869189e-08],
            [-3.083228948117951e-08, 2.2346819330658025e-08, 3.017429940090037e-08],
            [-3.204649947339576e-08, 2.1401721440698245e-08, 2.8152762709961765e-08],
            [-3.397642996700442e-08, 2.0534642545062902e-08, 2.6856876840740118e-08],
            [-3.6029001570846627e-08, 1.996349983285486e-08, 2.6404696994203207e-08],
            [-3.7985224801365124e-08, 1.929346777792206e-08, 2.5720167902748616e-08],
            [-3.9938512483713346e-08, 1.9076907041281768e-08, 2.6080237279666776e-08],
            [-4.134544267157501e-08, 1.7942408746145123e-08, 2.609217134157943e-08],
            [-4.085735707775771e-08, 1.9365066438359836e-08, 2.9770890007775875e-08],
            [-3.8164969588173383e-08, 2.0682291352885916e-08, 3.238946254741929e-08],
            [-3.522836299082102e-08, 2.1547267761460223e-08, 3.356903821648073e-08],
            [-3.2533739522956684e-08, 2.188612912608854e-08, 3.299560786780781e-08],
            [-3.1589535966151e-08, 2.1624441606135348e-08, 3.141567988552956e-08],
            [-3.0985472052409886e-08, 2.068503830395982e-08, 2.8147062860094487e-08],
            [-3.3214551403641027e-08, 1.9540404531660556e-08, 2.6172599457244346e-08],
            [-3.5699196229608137e-08, 1.8807520929427397e-08, 2.551782972986157e-08],
            [-3.817810312731604e-08, 1.8263043991395257e-08, 2.5354969180999815e-08],
            [-3.9076048776679616e-08, 1.6908600232965977e-08, 2.4460929672714255e-08],
            [-3.9733100136662554e-08, 1.7645139266924022e-08, 2.677503744063994e-08],
            [-3.6032554070531665e-08, 1.953619172256266e-08, 3.046158073231965e-08],
            [-3.3791308565533975e-08, 2.008896064185489e-08, 3.0920058356383144e-08],
            [-3.2352804330950876e-08, 1.9887798549822888e-08, 2.9245537638507128e-08],
            [-3.150142651429867e-08, 1.9426659070632092e-08, 2.731377622175266e-08],
            [-3.3048335254463425e-08, 1.8354389668866768e-08, 2.5164340138003388e-08],
            [-3.567120940080248e-08, 1.7574462627868073e-08, 2.4463323784739966e-08],
            [-4.315808389156621e-08, 2.265726290807808e-08, 3.4776305075888767e-08],
            [-3.723331620621694e-08, 2.0854217127892015e-08, 2.6948396171399203e-08],
            [-4.229013056073244e-08, 2.003768484327957e-08, 2.7276480036051767e-08],
            [-4.3922383246670064e-08, 2.020618601819057e-08, 2.8404083298355078e-08],
            [-4.4845224195074666e-08, 2.1134119238796608e-08, 3.1230769665087735e-08],
            [-3.6139179070927936e-08, 2.4758033504921888e-08, 3.7672900207383157e-08],
            [-3.299150168484106e-08, 2.2453074304154093e-08, 2.8886940848431763e-08],
            [-3.089261604534044e-08, 2.1236013376934135e-08, 2.9735771132050536e-08],
        ]
    )
    collection.orientation = Rotation.from_rotvec([0, 0, 30], degrees=True)
    magba_b = collection.get_B(points)
    assert_allclose(magba_b, magpy_b)

    # Move magnets
    magpy_b = np.array(
        [
            [-6.1931128263501726e-09, 1.0723229112998198e-09, -1.8500693225639605e-09],
            [-6.27359190619941e-09, 1.0633049952161231e-09, -1.877589072113912e-09],
            [-6.2145018897890515e-09, 1.1187451893270956e-09, -2.151368950246325e-09],
            [-6.112576773104061e-09, 1.1705119238571852e-09, -2.3709885435466428e-09],
            [-6.022699890082058e-09, 1.2095491061335314e-09, -2.5226186194817537e-09],
            [-5.926037288164082e-09, 1.2440804544252255e-09, -2.6097422131797855e-09],
            [-5.849141933278226e-09, 1.2664759204181423e-09, -2.621848297792383e-09],
            [-5.790468412238389e-09, 1.2784027395548187e-09, -2.585817198496091e-09],
            [-5.765192108733463e-09, 1.2718625644879966e-09, -2.484546530864933e-09],
            [-5.806819984749548e-09, 1.2355582732806103e-09, -2.314711807685404e-09],
            [-5.886686752163015e-09, 1.1879208485678253e-09, -2.146527622228631e-09],
            [-5.9743359325190166e-09, 1.1466485446187057e-09, -2.0244122154840215e-09],
            [-6.053143876881783e-09, 1.1062243529300616e-09, -1.898136101330691e-09],
            [-6.132924757244631e-09, 1.079973507856354e-09, -1.837780859165987e-09],
            [-6.3890076313374986e-09, 1.0861194234839833e-09, -1.8615760783489241e-09],
            [-6.383878484803504e-09, 1.1282869325342806e-09, -2.0922268427840942e-09],
            [-6.2872569049437304e-09, 1.186255684584174e-09, -2.347593259442968e-09],
            [-6.169394874664248e-09, 1.2385922297086258e-09, -2.5438767933311337e-09],
            [-6.043864508172325e-09, 1.282893671823438e-09, -2.6488421366859e-09],
            [-5.986971750942219e-09, 1.2945224673318915e-09, -2.6164686252538495e-09],
            [-5.9316493857621244e-09, 1.2879168894851965e-09, -2.467742638261756e-09],
            [-6.0290477421879955e-09, 1.2258529013379737e-09, -2.232905713954539e-09],
            [-6.143522175992718e-09, 1.1716275069190842e-09, -2.0708303962950983e-09],
            [-6.253897018553241e-09, 1.1266952620968282e-09, -1.948383035973921e-09],
            [-6.496509675488547e-09, 1.128872069316063e-09, -1.9363161321350343e-09],
            [-6.535267666725887e-09, 1.145101776456971e-09, -2.0575914939172353e-09],
            [-6.385250630895427e-09, 1.2378628163400367e-09, -2.4495175891281813e-09],
            [-6.280606003100486e-09, 1.2809657470929894e-09, -2.588115296406988e-09],
            [-6.196434326141668e-09, 1.2994100964882603e-09, -2.566247716343786e-09],
            [-6.137433246738701e-09, 1.302948030137233e-09, -2.493734480414712e-09],
            [-6.205068848871055e-09, 1.2493622375682676e-09, -2.270568429244175e-09],
            [-6.3350830226046675e-09, 1.188887348307971e-09, -2.0915439822524496e-09],
            [-6.0904223524933086e-09, 1.0792994724775082e-09, -2.0618354265837438e-09],
            [-5.845660776640972e-09, 1.10421299640502e-09, -1.922078869267303e-09],
            [-6.032943493606174e-09, 1.0336007300471046e-09, -1.7377407125378498e-09],
            [-6.091962913605284e-09, 1.0237733783091351e-09, -1.736308936217244e-09],
            [-6.131334545558552e-09, 1.0364366379595118e-09, -1.8408722081299814e-09],
            [-5.864326150231552e-09, 1.1825495988278517e-09, -2.4668544850304184e-09],
            [-5.683558068070423e-09, 1.1934240576648698e-09, -2.2163278488640056e-09],
            [-5.93942440915499e-09, 1.2998908535700036e-09, -2.562829783086725e-09],
        ]
    )
    collection.move(np.array([0, 0, -1]))
    magba_b = collection.get_B(points)
    assert_allclose(magba_b, magpy_b)

    # Rotate magnets
    magpy_b = np.array(
        [
            [-4.92028846155655e-09, 2.6292594941337264e-09, -5.35895820612982e-09],
            [-4.987566657654542e-09, 2.562373245624857e-09, -5.478517545137225e-09],
            [-4.849212691803024e-09, 2.5575031180610586e-09, -5.743171254720434e-09],
            [-4.687173555907414e-09, 2.5881694149018395e-09, -5.904099638101179e-09],
            [-4.557151849817311e-09, 2.619646538098979e-09, -5.999216792942686e-09],
            [-4.4402167691605826e-09, 2.6727422839994508e-09, -6.010107551478849e-09],
            [-4.364547893911665e-09, 2.7296345871631293e-09, -5.948301137463451e-09],
            [-4.320685936745845e-09, 2.7825099464325343e-09, -5.8446062516942344e-09],
            [-4.327976117887946e-09, 2.8230920518277596e-09, -5.692217234824942e-09],
            [-4.4184990563163426e-09, 2.8273533736427062e-09, -5.521799531439416e-09],
            [-4.544105644608431e-09, 2.801054699042412e-09, -5.395324650566592e-09],
            [-4.662909752550486e-09, 2.7599194164458994e-09, -5.336857402608388e-09],
            [-4.774936424057891e-09, 2.721499841529892e-09, -5.267300568395222e-09],
            [-4.867775854244168e-09, 2.673641112440405e-09, -5.27992791466774e-09],
            [-5.091166821920039e-09, 2.674646872045926e-09, -5.49071961528386e-09],
            [-5.0163561983075424e-09, 2.641808771098899e-09, -5.76008974415846e-09],
            [-4.84847957708809e-09, 2.664418968908324e-09, -5.967670063077328e-09],
            [-4.678752064506123e-09, 2.7088258701768583e-09, -6.087969683969452e-09],
            [-4.529558699196121e-09, 2.778736940542322e-09, -6.091962132943507e-09],
            [-4.486196937270041e-09, 2.8302692641361996e-09, -5.994392604898178e-09],
            [-4.4800505192050284e-09, 2.900258162425248e-09, -5.753073597002828e-09],
            [-4.642234402068557e-09, 2.8753328282778243e-09, -5.56045419766561e-09],
            [-4.7981389190034545e-09, 2.8221285187322147e-09, -5.480741869398212e-09],
            [-4.938344795771685e-09, 2.762011040247687e-09, -5.449348050997711e-09],
            [-5.159619415153071e-09, 2.7848382647450994e-09, -5.59890427646648e-09],
            [-5.1589595877546056e-09, 2.7392597249884317e-09, -5.784778358841258e-09],
            [-4.899706213842924e-09, 2.778558194862904e-09, -6.102054164891138e-09],
            [-4.759919555545621e-09, 2.825992307662155e-09, -6.166077404161201e-09],
            [-4.687941348900966e-09, 2.894524249619506e-09, -6.053593639631843e-09],
            [-4.655198125642989e-09, 2.949699733644925e-09, -5.904051805443792e-09],
            [-4.786220836969085e-09, 2.9408152418922572e-09, -5.697116321663048e-09],
            [-4.9617289960455056e-09, 2.8786334072648273e-09, -5.613806015902651e-09],
            [-4.769232945236308e-09, 2.474325219985006e-09, -5.592036550635555e-09],
            [-4.582203719304825e-09, 2.6833610388908205e-09, -5.164535788480216e-09],
            [-4.813365259801354e-09, 2.5747777184952433e-09, -5.143179909304364e-09],
            [-4.869150280684073e-09, 2.5312306882904817e-09, -5.2053240539612216e-09],
            [-4.874488241240163e-09, 2.4844406856267533e-09, -5.371734845633553e-09],
            [-4.434485911741081e-09, 2.5585310031594976e-09, -5.85252444090167e-09],
            [-4.341433260113152e-09, 2.7496326211056822e-09, -5.357594401511269e-09],
            [-4.4582464788660235e-09, 2.8761521140196692e-09, -5.879770440237096e-09],
        ]
    )
    collection.rotate(Rotation.from_rotvec([0, 20, 0], degrees=True))
    magba_b = collection.get_B(points)
    assert_allclose(magba_b, magpy_b)
